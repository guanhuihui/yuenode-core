<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>yuenode-core: Source: middleware/errorHandler.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: middleware/errorHandler.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * 错误处理中间件，将所有抛出的错误在此统一处理
 * @module middleware/errorHandler
 *
 * @param {object}  opt                     启动参数对象
 * @param {object}  opt.errorInfo           渲染错误页所需信息
 * @param {object}  opt.errorMsgPassword    显示错误信息 query 密码，例如为 error_show， 则在 url 后加入 ?error_show 就会显示错误信息
 */
      
const path = require('path');
const fs = require('fs');

const utils = require('../lib/utils.js');

module.exports = (opt) => function* onerror(next) {
    try {
        yield next;

        // 404
        if (this.status === 404) {
            let err = new Error('Not Found');
            err.status = 404;
            err.stack = 'Not Found';
            throw err;
        }
    } catch (err) {
        
        // ENOENT support
        if (err.code === 'ENOENT') {
            err.status = 404;
        }

        if (typeof err.status !== 'number') {
            err.status = 500;
        }
        this.status = err.status;

        // log
        this.appendLog(`ERRORMSG: ${err.message}`);

        // 静态化错误直接返回
        if (this.method.toUpperCase() === 'POST') {
            this.body = {
                code: err.status,
                msg: err.message,
                stack: err.stack
            };
            return false;
        }

        /**
         * 默认渲染错误数据，pro 环境可以通过 url 添加显示错误信息 query 密码来显示错误信息
         * @member errorinfo
         * @inner
         * @const
         * 
         * @property    {string}   code     错误状态码
         * @property    {string}   msg      错误描述信息
         * @property    {string}   stack    错误堆栈信息
         */
        let body = {
            code: this.status,
            msg: 'Something went wrong.',
            stack: ''
        };
        if (global.envType !== 'pro' || (opt.errorMsgPassword &amp;&amp; Object.keys(this.query).includes(opt.errorMsgPassword))) {
            body.msg = err.message;
            body.stack = err.stack;
        }
        body = typeof opt.errorInfo === 'object' ? Object.assign(body, opt.errorInfo) : body;

        // 渲染状态码错误页
        try {
            const page = `error/${this.status}.html`;
            try {
                // 渲染项目模板中的状态码错误页
                const host = utils.fixHost(this.host);
                this.body = this.render(path.join(host, page), body);
            } catch (err) {
                // 没有的话渲染项目views根目录中的状态码错误页
                this.body = this.render(page, body);
            }

        // 没有配置状态码错误页则渲染error.html
        } catch (err) {
            try {
                // 渲染项目模板中的error.html
                const host = utils.fixHost(this.host);
                this.body = this.render(path.join(host,'error'), body);
            } catch (err) {
                try {
                    // 没有的话渲染项目views根目录中的error.html
                    this.body = this.render('error', body);
                } catch (err) {
                    // 没有的话使用框架机中的error页面，不使用render防止是渲染出错
                    const errPath = path.join(__dirname, '../views/error.html');
                    let errTxt = fs.readFileSync(errPath, 'utf8');
                    this.body = errTxt
                        .replace('{{code}}', body.code)
                        .replace('{{msg}}', body.msg)
                        .replace('{{stack}}', body.stack);
                }
            }
        }
    }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-index.html">index</a></li><li><a href="module-middleware_addEjsRender.html">middleware/addEjsRender</a></li><li><a href="module-middleware_addOldRenderInfo.html">middleware/addOldRenderInfo</a></li><li><a href="module-middleware_characterConversion.html">middleware/characterConversion</a></li><li><a href="module-middleware_errorHandler.html">middleware/errorHandler</a></li><li><a href="module-middleware_favicon.html">middleware/favicon</a></li><li><a href="module-middleware_logger.html">middleware/logger</a></li><li><a href="module-middleware_monitorBack.html">middleware/monitorBack</a></li><li><a href="module-router_bothRouter.html">router/bothRouter</a></li><li><a href="module-router_dynamicRouter.html">router/dynamicRouter</a></li><li><a href="module-router_staticRouter.html">router/staticRouter</a></li><li><a href="module-router_vueRouter.html">router/vueRouter</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Jul 27 2017 18:25:22 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
